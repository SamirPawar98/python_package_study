name: Migrate Releases to GitHub Packages

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tools
        run: |
          pip install build twine

      - name: Build and upload each tag
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN  }}
        run: |
          set -e
          git fetch --tags

          for tag in $(git tag)
          do
            echo "=============================="
            echo "Processing $tag"
            echo "=============================="

            git checkout $tag

            # Inject repository metadata required by GitHub Packages
            if ! grep -q "\[project.urls\]" pyproject.toml 2>/dev/null; then
              echo "" >> pyproject.toml
              echo "[project.urls]" >> pyproject.toml
              echo "Repository = \"https://github.com/${GITHUB_REPOSITORY}\"" >> pyproject.toml
            else
              sed -i '/\[project.urls\]/,/^\[/ s|Repository *=.*|Repository = "https://github.com/'"${GITHUB_REPOSITORY}"'"|' pyproject.toml || true
            fi

            echo "Injected metadata:"
            grep -i repository -n pyproject.toml || true

            rm -rf dist build *.egg-info
            python -m build

            echo "Wheel metadata:"
            unzip -p dist/*.whl *.dist-info/METADATA | grep -i repository || true

            twine upload \
            --repository-url https://pip.pkg.github.com/${GITHUB_REPOSITORY}/ \
            dist/*

