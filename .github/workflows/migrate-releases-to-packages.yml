name: Migrate Releases to GitHub Packages

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tools
        run: |
          pip install build twine

      - name: Get tags
        id: tags
        run: |
          echo "TAGS=$(git tag | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Build and upload each tag
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          for tag in ${{ steps.tags.outputs.TAGS }}
          do
            echo "Processing $tag"
            git checkout $tag

            rm -rf dist build *.egg-info
            python -m build

            twine upload --repository-url https://pip.pkg.github.com/${{ github.repository_owner }}/ dist/* || true
          done
