name: Migrate Releases to GitHub Packages

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tools
        run: |
          pip install build twine

      - name: Build and upload each tag
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          set -e
          git fetch --tags

          for tag in $(git tag)
          do
            echo "=============================="
            echo "Processing $tag"
            echo "=============================="

            git checkout $tag

            echo "Before patch:"
            grep -n "Repository" pyproject.toml || true

            # Patch repository so GitHub Packages accepts upload
            sed -i 's|SamirPawar98/genericpkg|SamirPawar98/python_package_study|g' pyproject.toml

            echo "After patch:"
            grep -n "Repository" pyproject.toml || true

            rm -rf dist build *.egg-info
            python -m build

            echo "Metadata inside wheel:"
            unzip -p dist/*.whl *.dist-info/METADATA | grep -i repository || true

            twine upload \
              --repository-url https://pip.pkg.github.com/${{ github.repository_owner }}/ \
              dist/*
          done
